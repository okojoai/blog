---
Title: "【論文読み】FormalJudge: A Neuro-Symbolic Paradigm for Agentic Oversight"
Category:
- 論文読み
- Artificial Intelligence
Draft: true
EditURL: https://blog.hatena.ne.jp/okojoai/okojoai.hatenablog.com/atom/entry/17179246901354004362
---

# FormalJudge: LLMの監視に「数学的証明」を持ち込んだ野心作

## 1. 3行でわかるこの論文

- **LLMでLLMを監視する「LLM-as-a-Judge」は確率的システム同士の堂々巡り**。この論文は形式検証（Formal Verification）で抜け出す道を提案
- **Neuro-Symbolicの二段構え**：LLMで自然言語→形式仕様に変換し、DafnyとZ3ソルバーで数学的証明を生成。確率スコアではなく「証明可能か否か」で判定
- **7BモデルでGPT-4クラス（72B）の嘘を90%検出**。Weak-to-Strong監視が可能で、反復改善により安全性がほぼ線形に向上

---

## 2. なぜこれが「おもしろい」のか？（主観セクション）

正直、**LLM-as-a-Judgeの限界には誰もが気づいていた**。GPT-4にGPT-4の出力を評価させて「90点です！」と言われても、それ自体が幻覚かもしれない。確率的システムで確率的システムを監視する構造は、本質的に再帰的な不確実性を抱える。

この論文が「熱い」のは、**形式手法（Formal Methods）という古典的で厳密な世界をLLMエージェントの監視に持ち込んだ**こと。Dafnyで仕様を記述し、Z3ソルバーで充足可能性を証明する——つまり「このエージェントの振る舞いは、与えられた制約を**数学的に満たす**」と保証できる。これは推論のパラダイムシフトだ。

個人的に痺れたのは**Bidirectional Formal-of-Thought（双方向形式思考）**の設計。Top-downで人間の意図を原子的制約に分解し、Bottom-upで証明を積み上げる。LLMの「曖昧さを扱う柔軟性」と形式検証の「厳密性」を、見事にハイブリッド化している。

ただし——と言わざるを得ないが——**形式仕様への翻訳がボトルネック**という指摘は、実は問題を先送りしているだけでは？という懸念も残る。後述する。

---

## 3. 技術の核心：ここがエグい

### 3.1 双方向Formal-of-Thoughtアーキテクチャ

FormalJudgeの心臓部は、以下の2段階プロセス：

#### **Top-down: Specification Compilation**
```
自然言語要求 → LLM → 形式仕様（Dafny）
```
例えば「個人情報を漏らしてはいけない」という要求を、
```dafny
method CheckPrivacy(response: string) returns (safe: bool)
  ensures safe <==> !ContainsPII(response)
```
のような検証可能な述語に変換。

#### **Bottom-up: Compliance Proving**
```
エージェント出力 + 形式仕様 → Z3ソルバー → SAT/UNSAT
```
Z3が「この出力は仕様を満たす（SAT）」または「満たさない（UNSAT）」を**数学的に判定**。

数式で書くなら、従来のLLM-as-a-Judgeは
$$
\text{Score} = P_{\text{judge}}(\text{safe} \mid \text{output}, \text{requirement})
$$
と確率的評価だったのに対し、FormalJudgeは
$$
\text{Verdict} = \begin{cases}
\text{SAFE} & \text{if } \vdash \phi(\text{output}) \\
\text{UNSAFE} & \text{otherwise}
\end{cases}
$$
と、論理的証明可能性 $\vdash \phi$ で判定する。**確率ではなく証明**。これが本質。

### 3.2 Weak-to-Strong Generalization

論文の実験で最も興味深いのは、**7BモデルのJudgeが72Bエージェントの嘘を90%以上検出した**点。

従来、小さいモデルで大きいモデルを監視するのは無理ゲーだった（能力が足りないから）。だがFormalJudgeでは、**仕様への翻訳さえ成功すれば、後はZ3が決定論的に判定する**。つまり：

- LLMの役割：曖昧な人間言語→形式言語の「翻訳者」（ここは小規模モデルでもOK）
- Z3の役割：厳密な論理判定（ここは確定的）

**監視能力がモデルサイズに依存しない**のが、形式検証の強み。

---

## 4. 現場エンジニアが直面しそうな「壁」

### 4.1 **形式仕様への翻訳精度が全て**
論文は「LLMが自然言語→Dafny仕様に変換する」とサラッと書いているが、**これ自体が超難しい**。

- 「個人情報を漏らすな」を形式化するには、PII（個人識別情報）の定義、正規表現、文脈依存性を全て記述する必要がある
- LLMが生成した仕様が**間違っていたら、証明も意味がない**（Garbage In, Garbage Out）
- 論文中、仕様生成の失敗率や人間による修正コストへの言及が薄い

つまり「確率的システムの監視問題」が「確率的な仕様生成問題」にすり替わっただけでは？という批判は免れない。

### 4.2 **Z3の実行コスト**
SMTソルバー（Z3）は、制約が複雑になると**指数関数的に遅くなる**（NP完全問題だから当然）。

- 論文のベンチマークは「3つの制約を同時に満たすか？」程度だが、**実世界のエージェントは数十〜数百の暗黙制約を持つ**
- エッジデバイス（Jetson等）でZ3を動かすのは現実的か？クラウドに投げるならレイテンシは？
- 反復改善（Iterative Refinement）で線形改善と言うが、各イテレーションでZ3を叩くなら、**実行時間は線形どころか二次以上に増える**のでは？

### 4.3 **Dafnyの学習コスト**
形式仕様の記述には、Dafnyや契約プログラミングの知識が必要。

- エンジニアが「仕様書を書く」ではなく「検証可能な仕様を書く」スキルを習得する必要がある
- LLMに丸投げできるなら良いが、前述の通り生成仕様のレビューは人間が必要
- **形式手法チームと機械学習チームの協業が必須**（組織的ハードル）

### 4.4 **カバレッジの限界**
形式検証は「書かれた仕様」しか検証しない。

- 「仕様に書き忘れた制約」は素通り（例：「差別的発言をしない」と書き忘れたら、差別発言し放題）
- LLM-as-a-Judgeは「常識的におかしい」も検出できる（場合によっては）が、形式検証は**明示されたルールのみ**
- **仕様の網羅性をどう保証する？**が新たな課題

---

## 5. 【人間が追記するためのメモ】

### 社内プロジェクトでの検証アイデア
- [ ] **自社のRAGエージェントに適用してみる**  
  「検索結果に社外秘情報を含まない」という制約を形式仕様化し、FormalJudgeで監視。従来のルールベース漏洩検知との精度比較を取る。

- [ ] **Dafny仕様のテンプレート化**  
  頻出する制約（PII漏洩、有害発言、コンプライアンス違反等）をDafnyテンプレートとして事前に用意。LLMはパラメータ埋めだけに専念させれば、翻訳精度が上がるのでは？

- [ ] **Z3実行時間のプロファイリング**  
  実際の業務データで、制約数 vs Z3実行時間の関係をプロット。どのくらいの複雑さまで実用的か閾値を見極める。

### 実装時のチェックポイント
- Dafny生成時に**人間がレビューするフロー**を必ず挟む（自動化は段階的に）
- Z3がタイムアウトした場合のフォールバック戦略（LLM-as-a-Judgeに切り替え？）
- 仕様のバージョン管理（GitOpsみたいに、形式仕様もCI/CDに組み込む）

### 尖った問い
- **「確率的翻訳→決定論的証明」は本当にロバストか？**  
  翻訳が95%正確でも、誤訳した5%で重大な抜け穴が生まれるなら、結局安全性は保証できないのでは？  
  → 人間による仕様監査（Specification Audit）の自動化が次の研究テーマ？

- **形式検証 + LLMのハイブリッドは他にも応用できる？**  
  コード生成時の契約検証、マルチエージェント交渉の合意形成、RL方策の安全制約など、応用範囲は広そう。

- **敵対的攻撃への耐性は？**  
  エージェントが「仕様の穴を突く」ように学習したら？形式仕様も敵対的サンプルみたいに騙せるのでは？

---

**執筆者の本音**：  
形式検証とLLMの融合、方向性は100点満点で面白い。ただ「自然言語→形式仕様」の翻訳精度が実用の鍵を握っている以上、現時点では**PoC止まり**だと思う。逆に言えば、ここを突破できたら**LLMの信頼性革命**が起きる。うちでも小規模に試して、泥臭いデータを取りたい。

---
> **原論文**: [FormalJudge: A Neuro-Symbolic Paradigm for Agentic Oversight](https://arxiv.org/abs/2602.11136v1)
> 
> **この記事は AI によって生成された下書きです。公開前に人間のレビューが必要です。**
